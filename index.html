<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Writing Rubric - Grading Dashboard</title>
    <!-- Excel Export Library -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); overflow: hidden; }
        
        /* Sidebar Styles */
        #sidebar { width: 300px; background: var(--primary); color: white; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        #sidebar h2 { padding: 20px; font-size: 1.2rem; margin: 0; background: #1a252f; border-bottom: 1px solid #34495e; }
        .essay-list { overflow-y: auto; flex-grow: 1; }
        .essay-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #34495e; font-size: 14px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .essay-item:hover { background: #34495e; }
        .essay-item.active { background: var(--accent); font-weight: bold; }
        .essay-item.graded::after { content: "✅"; color: #2ecc71; font-weight: bold; }

        /* PDF Viewer and Rubric Split */
        #main { flex-grow: 1; display: flex; }
        #pdf-viewer { flex: 1; border: none; background: #525659; }

        /* Rubric Panel Styles */
        #rubric-panel { width: 480px; background: white; padding: 25px; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        .section-header { background: #ebf5fb; color: #2980b9; padding: 10px 15px; font-weight: bold; margin-top: 20px; border-left: 5px solid var(--accent); font-size: 0.9rem; border-radius: 0 4px 4px 0; }
        .rubric-item { margin: 15px 0; font-size: 0.85rem; }
        .rubric-item label { font-weight: 600; display: block; margin-bottom: 5px; color: #34495e; }
        select, input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; background: #fff; }
        
        .total-box { background: #fdf2f2; border: 2px solid #e74c3c; border-radius: 8px; padding: 15px; margin: 25px 0; text-align: center; }
        .total-label { color: #7f8c8d; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; }
        #total-val { font-size: 2.5rem; font-weight: bold; color: #e74c3c; display: block; }

        /* Buttons */
        button { width: 100%; padding: 14px; margin-top: 10px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-save { background: #27ae60; color: white; font-size: 1rem; box-shadow: 0 4px 0 #219150; }
        .btn-save:active { transform: translateY(2px); box-shadow: 0 2px 0 #219150; }
        .btn-export { background: var(--accent); color: white; }
        .btn-clear { background: #95a5a6; color: white; font-size: 0.7rem; margin-top: 30px; opacity: 0.7; }
        .btn-clear:hover { opacity: 1; background: #c0392b; }
        
        label.chk-container { display: flex; align-items: center; font-weight: normal; cursor: pointer; padding: 4px 0; }
        label.chk-container input { margin-right: 10px; transform: scale(1.2); }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Student Essays (1-51)</h2>
    <div class="essay-list" id="essayList"></div>
    <div style="padding: 15px; background: #1a252f;">
        <button class="btn-export" onclick="exportExcel()">Download Detailed Excel</button>
        <button class="btn-clear" onclick="clearData()">Clear All Stored Scores</button>
    </div>
</div>

<div id="main">
    <iframe id="pdf-viewer" src="about:blank"></iframe>
    <div id="rubric-panel">
        <h2 id="essay-title" style="margin-top:0; color:var(--primary);">Select a student essay</h2>
        
        <!-- 1. ACCURACY (30 pts) -->
        <div class="section-header">1. ACCURACY (30 pts)</div>
        <div class="rubric-item">
            <label>Vocabulary Accuracy (10)</label>
            <select id="acc_v" onchange="updateTotal()">
                <option value="10">0–1 vocabulary errors (10)</option>
                <option value="7">2–3 vocabulary errors (7)</option>
                <option value="5">4–5 vocabulary errors (5)</option>
                <option value="3">Frequent errors; meaning sometimes unclear (3)</option>
                <option value="1">Widespread errors; meaning often unclear (1)</option>
            </select>
        </div>
        <div class="rubric-item">
            <label>Grammar Accuracy (10)</label>
            <select id="acc_g" onchange="updateTotal()">
                <option value="10">0–1 grammar errors (10)</option>
                <option value="7">2–3 grammar errors (7)</option>
                <option value="5">4–5 grammar errors (5)</option>
                <option value="3">Frequent grammar errors; clarity affected (3)</option>
                <option value="1">Persistent major errors; meaning unclear (1)</option>
            </select>
        </div>
        <div class="rubric-item">
            <label>Character Accuracy (10)</label>
            <select id="acc_c" onchange="updateTotal()">
                <option value="10">0–4 wrong characters/pinyin (10)</option>
                <option value="7">5–10 wrong characters/pinyin (7)</option>
                <option value="5">10–15 wrong characters/pinyin (5)</option>
                <option value="3">Many errors; regular Pinyin use (3)</option>
                <option value="1">Very many errors; heavy Pinyin use (1)</option>
            </select>
        </div>

        <!-- 2. RANGE (30 pts) -->
        <div class="section-header">2. RANGE (30 pts)</div>
        <div class="rubric-item">
            <label>Vocabulary Range (15)</label>
            <select id="ran_v" onchange="updateTotal()">
                <option value="15">Many newly learned + some exceeding level (15)</option>
                <option value="12">Many newly learned vocabulary items used (12)</option>
                <option value="9">Some vocabulary newly learned used (9)</option>
                <option value="6">Only a few newly learned; very simple (6)</option>
                <option value="3">Vocabulary almost entirely basic (3)</option>
            </select>
        </div>
        <div class="rubric-item">
            <label>Language Point Range (15)</label>
            <select id="ran_l" onchange="updateTotal()">
                <option value="15">7+ points, 1–2 beyond level (15)</option>
                <option value="12">7+ language points (12)</option>
                <option value="9">5 language points (9)</option>
                <option value="6">3 language points (6)</option>
                <option value="3">Fewer than 3 language points (3)</option>
            </select>
        </div>

        <!-- 3. TOPIC DEVELOPMENT & ORGANISATION (30 pts) -->
        <div class="section-header">3. TOPIC DEVELOPMENT & ORGANISATION (30 pts)</div>
        <div class="rubric-item">
            <label>Relevance (5)</label>
            <select id="t_rel" onchange="updateTotal()">
                <option value="5">Fully relevant to the task (5)</option>
                <option value="4">Mostly relevant to the task (4)</option>
                <option value="3">Generally relevant to the task (3)</option>
                <option value="2">Partly relevant to the task (2)</option>
                <option value="1">Limited relevance to the task (1)</option>
            </select>
        </div>
        <div class="rubric-item">
            <label>Detail (5)</label>
            <select id="t_det" onchange="updateTotal()">
                <option value="5">Elaborated detail with depth (5)</option>
                <option value="4">Sufficient detail (4)</option>
                <option value="3">Some detail (3)</option>
                <option value="2">Minimal detail (2)</option>
                <option value="1">Details lacking (1)</option>
            </select>
        </div>
        <div class="rubric-item">
            <label>Length (5)</label>
            <select id="t_len" onchange="updateTotal()">
                <option value="5">Length more than 2 pages (5)</option>
                <option value="3">Length more than 1 page (3)</option>
                <option value="1">Length less than 1 page (1)</option>
            </select>
        </div>
        <div class="rubric-item">
            <label>Paragraphing (5)</label>
            <select id="t_par" onchange="updateTotal()">
                <option value="5">Clear and balanced paragraphing (5)</option>
                <option value="4">Clear paragraphing with minor imbalance (4)</option>
                <option value="3">Paragraphing present but uneven (3)</option>
                <option value="2">Paragraphing unclear or weak (2)</option>
                <option value="1">Paragraphing insufficient/absent (1)</option>
            </select>
        </div>
        <div class="rubric-item">
            <label>Logical Order (5)</label>
            <select id="t_ord" onchange="updateTotal()">
                <option value="5">Fully logical with smooth flow (5)</option>
                <option value="4">Mostly logical sequence (4)</option>
                <option value="3">Generally logical with lapses (3)</option>
                <option value="2">Sequence sometimes confusing (2)</option>
                <option value="1">Often illogical or disconnected (1)</option>
            </select>
        </div>
        <div class="rubric-item">
            <label>Cohesive Devices (5)</label>
            <select id="t_coh" onchange="updateTotal()">
                <option value="5">3+ used effectively (5)</option>
                <option value="4">2 used appropriately (4)</option>
                <option value="3">1 used appropriately (3)</option>
                <option value="2">Minimal cohesive devices (2)</option>
                <option value="1">Few or no cohesive devices (1)</option>
            </select>
        </div>

        <!-- 4. FORMAT (10 pts) -->
        <div class="section-header">4. FORMAT REQUIREMENTS (10 pts)</div>
        <div class="rubric-item" id="format-checks">
            <label class="chk-container"><input type="checkbox" class="f-chk" value="2" onchange="updateTotal()"> Title in the middle (2)</label>
            <label class="chk-container"><input type="checkbox" class="f-chk" value="2" onchange="updateTotal()"> Paragraph indentation (2)</label>
            <label class="chk-container"><input type="checkbox" class="f-chk" value="2" onchange="updateTotal()"> No blank lines (2)</label>
            <label class="chk-container"><input type="checkbox" class="f-chk" value="2" onchange="updateTotal()"> Narrative format (2)</label>
            <label class="chk-container"><input type="checkbox" class="f-chk" value="2" onchange="updateTotal()"> Punctuation marks (2)</label>
        </div>

        <!-- Total Calculation -->
        <div class="total-box">
            <span class="total-label">FINAL SCORE</span>
            <span id="total-val">0</span>
        </div>
        
        <button class="btn-save" onclick="saveGrade()">Save Grade for Student</button>
    </div>
</div>

<script>
    const GITHUB_PDF_PATH = "https://kkz2025.github.io/Chinesewriting/students%20essays/";
    // Unique key for storage to avoid conflicts with older versions
    const DB_KEY = 'chineseGrades_Final_v1';
    let allGrades = JSON.parse(localStorage.getItem(DB_KEY)) || {};
    let currentId = null;

    // Load Essay List in Sidebar
    const listContainer = document.getElementById('essayList');
    for(let i=1; i<=51; i++) {
        const item = document.createElement('div');
        item.className = `essay-item ${allGrades[i] ? 'graded' : ''}`;
        item.id = `essay-${i}`;
        item.innerHTML = `<span>Student Essay #${i}</span>`;
        item.onclick = () => loadEssay(i);
        listContainer.appendChild(item);
    }

    function loadEssay(id) {
        currentId = id;
        document.querySelectorAll('.essay-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`essay-${id}`).classList.add('active');
        document.getElementById('essay-title').innerText = `Grading Essay #${id}`;
        document.getElementById('pdf-viewer').src = `${GITHUB_PDF_PATH}${id}.pdf`;

        if(allGrades[id]) {
            const g = allGrades[id];
            document.getElementById('acc_v').value = g.acc_v;
            document.getElementById('acc_g').value = g.acc_g;
            document.getElementById('acc_c').value = g.acc_c;
            document.getElementById('ran_v').value = g.ran_v;
            document.getElementById('ran_l').value = g.ran_l;
            document.getElementById('t_rel').value = g.t_rel;
            document.getElementById('t_det').value = g.t_det;
            document.getElementById('t_len').value = g.t_len;
            document.getElementById('t_par').value = g.t_par;
            document.getElementById('t_ord').value = g.t_ord;
            document.getElementById('t_coh').value = g.t_coh;
            const checks = document.querySelectorAll('.f-chk');
            checks.forEach((c, idx) => c.checked = g.format_checklist[idx]);
        }
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        const keys = ['acc_v','acc_g','acc_c','ran_v','ran_l','t_rel','t_det','t_len','t_par','t_ord','t_coh'];
        keys.forEach(id => total += parseInt(document.getElementById(id).value || 0));
        document.querySelectorAll('.f-chk:checked').forEach(() => total += 2);
        document.getElementById('total-val').innerText = total;
        return total;
    }

    function saveGrade() {
        if(!currentId) return alert("Select an essay from the list first!");
        
        allGrades[currentId] = {
            acc_v: document.getElementById('acc_v').value,
            acc_g: document.getElementById('acc_g').value,
            acc_c: document.getElementById('acc_c').value,
            ran_v: document.getElementById('ran_v').value,
            ran_l: document.getElementById('ran_l').value,
            t_rel: document.getElementById('t_rel').value,
            t_det: document.getElementById('t_det').value,
            t_len: document.getElementById('t_len').value,
            t_par: document.getElementById('t_par').value,
            t_ord: document.getElementById('t_ord').value,
            t_coh: document.getElementById('t_coh').value,
            format_checklist: Array.from(document.querySelectorAll('.f-chk')).map(c => c.checked),
            total_score: updateTotal()
        };
        
        localStorage.setItem(DB_KEY, JSON.stringify(allGrades));
        document.getElementById(`essay-${currentId}`).classList.add('graded');
        alert("Scores saved for Student #" + currentId);
    }

    function exportExcel() {
        if(Object.keys(allGrades).length === 0) return alert("No grades found. Please save at least one essay score.");
        
        const dataRows = Object.keys(allGrades).sort((a,b)=>a-b).map(id => {
            const g = allGrades[id];
            return {
                "Essay ID": "Student " + id,
                "FINAL SCORE": g.total_score,
                "ACC: Vocabulary (10)": g.acc_v,
                "ACC: Grammar (10)": g.acc_g,
                "ACC: Characters (10)": g.acc_c,
                "RAN: Vocabulary (15)": g.ran_v,
                "RAN: Language Points (15)": g.ran_l,
                "ORG: Relevance (5)": g.t_rel,
                "ORG: Detail (5)": g.t_det,
                "ORG: Length (5)": g.t_len,
                "ORG: Paragraphing (5)": g.t_par,
                "ORG: Logical Order (5)": g.t_ord,
                "ORG: Cohesive Devices (5)": g.t_coh,
                "FMT: Title Middle (2)": g.format_checklist[0] ? 2 : 0,
                "FMT: Indentation (2)": g.format_checklist[1] ? 2 : 0,
                "FMT: No Blank Lines (2)": g.format_checklist[2] ? 2 : 0,
                "FMT: Narrative (2)": g.format_checklist[3] ? 2 : 0,
                "FMT: Punctuation (2)": g.format_checklist[4] ? 2 : 0
            };
        });

        const worksheet = XLSX.utils.json_to_sheet(dataRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Grading Results");
        XLSX.writeFile(workbook, "Detailed_Student_Writing_Grades.xlsx");
    }

    function clearData() {
        if(confirm("DANGER: This will delete ALL saved scores for ALL students. Are you sure?")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }
</script>
</body>
</html>
